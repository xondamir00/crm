generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  TEACHER
  STUDENT
}
enum TeacherRole {
  LEAD  //Asosiy o‚Äòqituvchi
  ASSISTANT //Yordamchi
  SUBSTITUTE //O‚Äòrinbosar (vaqtinchalik)
}

enum DayOfWeek {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}
enum DaysPattern {
  ODD   // Du/Cho/Ju
  EVEN  // Se/Pa/Sha
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  LEFT
}

enum SheetStatus { 
  OPEN 
  LOCKED 
}
enum AttendanceStatus { 
  PRESENT //Darsda ishtirok etgan
  ABSENT //Umuman kelmagan
  LATE //Kechikib kelgan
  EXCUSED //Uzrli sabab bilan kelmagan
}


model User {
  id               String   @id @default(cuid())
  firstName        String
  lastName         String
  phone            String   @unique
  passwordHash     String
  role             Role     @default(STUDENT)
  isActive         Boolean  @default(true)
  refreshTokenHash String?
  createdAt        DateTime @default(now())
  // üîÅ back-relations (har biri optional ‚Äî 1:1)
  teacherProfile TeacherProfile?
  studentProfile StudentProfile?
  managerProfile ManagerProfile?
  @@index([role])
  @@index([isActive])
}

model ManagerProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  photoUrl      String?
  monthlySalary Decimal @db.Decimal(10, 2)
}

model TeacherProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  photoUrl      String?
  monthlySalary Decimal? @db.Decimal(10, 2)
  percentShare  Decimal? @db.Decimal(5, 2) 
  teachingAssignment TeachingAssignment[]
}

model TeachingAssignment {
  id          String       @id @default(uuid())
  teacherId   String
  groupId     String
  fromDate    DateTime
  toDate      DateTime?

  role        TeacherRole  @default(LEAD)

  inheritSchedule Boolean  @default(true)
  daysPatternOverride DaysPattern?
  startMinutesOverride Int?
  endMinutesOverride   Int?

  isActive    Boolean     @default(true)
  assignedBy  String?
  note        String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deactivatedAt DateTime?
  deactivatedBy String?
  deactivateReason String?

  teacher     TeacherProfile @relation(fields: [teacherId], references: [id])
  group       Group          @relation(fields: [groupId], references: [id])

  @@index([teacherId, isActive])
  @@index([groupId, isActive])
  @@index([fromDate])
  @@index([toDate])
}

model StudentProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  dateOfBirth DateTime?
  startDate   DateTime?
  enrollments Enrollment[]
  attendance    Attendance[]
}
model Room {
  id        String   @id @default(uuid())
  name      String   @unique
  capacity  Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  groups Group[]
  
}


model Group {
  id             String      @id @default(uuid())
  name           String
  capacity       Int
  daysPattern    DaysPattern
  startMinutes   Int 
  endMinutes     Int
  monthlyFee     Int          @default(0)
  isActive       Boolean      @default(true)
  roomId         String?
  room           Room?        @relation(fields: [roomId], references: [id])
  deactivatedAt  DateTime?
  deactivatedBy  String?
  deactivateReason String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  enrollments Enrollment[]
  sheet AttendanceSheet[]
  teachingAssignment TeachingAssignment[]
  @@index([roomId, daysPattern, isActive])
  @@unique([name, isActive])
}

model Enrollment {
  id         String            @id @default(uuid())
  studentId  String
  groupId    String
  joinDate   DateTime
  leaveDate  DateTime?
  status     EnrollmentStatus  @default(ACTIVE)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  student    StudentProfile    @relation(fields: [studentId], references: [id])
  group      Group             @relation(fields: [groupId], references: [id])

  @@index([studentId, groupId])
}

model Attendance {
  id        String           @id @default(uuid())
  sheetId   String
  studentId String
  status    AttendanceStatus
  markedBy  String?
  markedAt  DateTime?
  note      String?

  sheet   AttendanceSheet @relation(fields: [sheetId],   references: [id])
  student StudentProfile  @relation(fields: [studentId], references: [id])

  @@unique([sheetId, studentId])
  @@index([studentId, status])
}


model AttendanceSheet {
  id            String       @id @default(uuid())
  groupId       String
  date          DateTime     
  startMinutes  Int          
  endMinutes    Int
  teacherAssignId String?    
  status        SheetStatus  @default(OPEN)
  note          String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  group         Group    @relation(fields: [groupId], references: [id])
  attendance    Attendance[]

  @@unique([groupId, date]) // bir guruh + bir kun = bitta varaq
  @@index([date])
}